[tox]
skipsdist = True

[testenv:flake8]
deps = 
    flake8
changedir =
    server-side
commands =
    flake8 . --exclude=*/venv/,*/migrations/,*/settings.py --show-source --count
    flake8 itaigi/settings.py --ignore E501 --show-source --count

[testenv:django-settings]
changedir =
    server-side
deps =
    -rserver-side/requirements.txt
commands =
    python manage.py makemigrations

[testenv:checkmigrations]
changedir =
    server-side
deps =
    -rserver-side/requirements.txt
commands =
    python manage.py makemigrations --check

[testenv:checkdeploy]
allowlist_externals =
    docker
setenv =
    VIRTUAL_HOST = localhost.ithuan.tw
    SECRET_KEY = localhost-TEkip/1faRS/aLGdcWbDxaEYD2E7t2M0tetDP8hige0vphXKy1kRqnFfg0OydCNJ+rKukWuBidzAwbzCEFMLu4
    # Bua̋i做ê代誌，因為admin加foreign key ê時ài iframe。毋過檢查建議iframe全部Deny。
    X_FRAME_OPTIONS = DENY
commands =
    docker build -t kautian .
    docker run --rm \
        --env VIRTUAL_HOST --env SECRET_KEY kautian \
        python manage.py compilemessages \
        --locale und_Latn --locale und_Hani --locale zh_Hant
    docker run --rm \
        --env VIRTUAL_HOST --env SECRET_KEY kautian \
        python manage.py collectstatic --noinput --clear
    docker run --rm \
        --env VIRTUAL_HOST --env SECRET_KEY --env X_FRAME_OPTIONS kautian \
        python manage.py check --deploy --fail-level WARNING
